\chapter{Аналитический раздел}

В данном разделе будут описаны существующие методы представления облаков.

\section{Модель облаков}
\label{math}
Облака можно представить с помощью участвующей среды (от англ. Participating Media) \cite{partmedia, frostbite, hzd, clouds}.

Участвующая среда --- термин, используемый для описания объемов, заполненных частицами. Этими частицами могут являться: капли воды, кристаллы льда, пыль, молекулы. Проходя через такую среду, свет взаимодействует с частицами и может отражаться, поглощаться или рассеиваться \cite{frostbite}.  

\subsection{Закон Бугера-Ламберта-Бера}
Закон Бугера-Ламберта-Бера -- определяет ослабление пучка света при распространении его в поглощающей среде. 
Свет, проходя сквозь вещество, подвергается поглощению этим самым веществом. Для дифференциального расстояния $ dx $ относительное уменьшение яркости определяется как $ k_a(x)dx $, где $ k_a(x) $ -- коэффициент поглощения среды в точке x. Часть света под воздействием частиц вещества меняет свое направление. Доля рассеянного света определяется как $ k_s(x)dx $, где $ k_s(x) $ -- коэффициент рассеивания. Тогда введем коэффициент затухания $ k_t(x)  = k_a(x) + k_s(x) $, яркость в точке $x$ находится следующим образом (Закон Бугера-Ламберта-Бера):  
\begin{equation}
	\label{beers_law}
	L(x) = L(x_0) e^{-\int_{x_0}^{x} k_t(u)\,du}=L(x_0)\tau(x_0, x) 
\end{equation}
где $ L(x) $ -- яркость в точке $ x $. Функцию $ \tau(x_0, x) = e^{-\int_{x_0}^{x} k_t(u)\,du}  $ называют передаточной функцией, она показывает какая доля света останется при прохождении из точки $ x_0 $ в точку $ x $ \cite{partmedia}.

\subsection{Фазовая функция}
Чтобы вывести уравнение переноса (англ. transport equation), необходимо учитывать увеличение яркости из-за эмиссии и рассеивания света в направлении распространения луча. Пространственное распределение рассеянного света моделируется фазовой функцией $ p(\vec{\omega}, \vec{\omega}') $. Фазовая функция имеет физическую интерпретацию как интенсивность рассеяния в направлении $\vec{\omega}$, деленная на интенсивность, которая была бы рассеяна в этом направлении, если бы рассеяние было изотропным (т.е. независимым от направления). Фазовые функции в компьютерной графике обычно симметричны относительно направления падения, поэтому их можно параметризовать углом между входящим и исходящим лучами. В качестве фазовой функции для облаков используется функция Хеньи -- Гринштейна \eqref{HG}:
\begin{equation}
	\label{HG}
	p(\theta) = \frac{1}{4\pi} \frac{1 - g^2}{(1 + g^2 - 2g\cos \theta)^{3/2}}
\end{equation}
где $ g $ -- варьируемый параметр, причем $ -1 \leq g \leq 1 $, а $\theta$ -- угол между входящим и исходящим лучами \cite{clouds}.

\subsection{Уравнение переноса}
Уравнение переноса описывает изменение яркости внутри участвующей среды в точке $ x $:
\begin{equation}
	\label{rte}
	\begin{aligned}
		\frac{dL(x, \vec{\omega})}{dx} = & k_t(x) J(x, \vec{\omega}) - k_t(x) L(x, \vec{\omega})  = \\
		& k_a(x) L_e(x, \vec{\omega}) + \frac{k_s(x)}{4\pi} \int_{4\pi} p(\vec{\omega}', \vec{\omega}) L(x, \vec{\omega}') d\omega' - \\
		& k_a(x) L(x, \vec{\omega}) - k_s(x) L(x, \vec{\omega})	
	\end{aligned}
\end{equation}
где $ L_e(x, \vec{\omega}) $ -- яркость выделенного света (эмиссии), а $ J(x, \vec{\omega}) $ -- вносимая яркость. Стоит заметить, что явление эмиссии не относится к облакам, т.~к. в облаках не наблюдается люминесценция.    

Используя альбедо однократного рассеяния $ \Omega = \frac{k_s}{k_t} $, мы можем записать вносимую яркость $J$, как:
\begin{equation}
	\label{sourcerad}
	\begin{aligned}
		J(x, \vec{\omega}) = \underbrace{(1 - \Omega(x)) L_e(x, \vec{\omega})}_{J_e(x, \vec{\omega})} + \frac{\Omega(x)}{4\pi} \int_{4\pi} p(\vec{\omega}', \vec{\omega}) L(x, \vec{\omega}') d\omega'
	\end{aligned}
\end{equation}
Вносимая яркость описывает вклады яркости в луч $ (x, \vec{\omega}) $ в точке $ x $ внутри среды, которые обуславливаются эмиссией света и рассеянными в рассматриваемом направлении лучами. 

Проинтегрировав уравнение переноса \eqref{rte}, получим:
\begin{equation}
	\label{rteint}
	\begin{aligned}
		L(x, \vec{\omega}) =
		\underbrace{\tau(x_0, x) L(x_0, \vec{\omega})}_{L_{ri}(x, \vec{\omega})} + \underbrace{\int_{x_0}^{x} \tau(u, x) k_t(u) J(u, \vec{\omega}) du}_{L_m(x, \vec{\omega})}
	\end{aligned}
\end{equation}
где $ L_{ri}(x, \vec{\omega}) $ -- яркость падающего света, а $ L_m(x, \vec{\omega}) $ -- яркость, обусловленная явлениями внутри среды. 

Целью алгоритмов рендеринга является разрешение уравнения \eqref{rteint}, по крайней мере для точек видимых относительно камеры \cite{partmedia}. 

\subsection{Однократное рассеивание}

Сложность решения \ref{rteint} заключается в том, что $L$ появляется в обеих частях уравнения (неявно через $J$). Приближенное решение состоит в том, чтобы учитывать только определенное количество событий рассеяния и рассчитывать затухание луча на промежутках между этими событиями. Считаем вклад яркости за счет явлений в среде равным нулю, тогда:
\begin{equation}
	\label{jss}
	\begin{aligned}
		J(x, \vec{\omega}) \approx J_{SS}(x, \vec{\omega}) = J_e(x, \vec{\omega}) + \frac{\Omega(x)}{4\pi} \int_{4\pi} p(\vec{\omega}', \vec{\omega}) L_{ri}(x, \vec{\omega}') d\omega'
	\end{aligned}
\end{equation}

C учетом \ref{jss} и \ref{rteint}, получаем:
\begin{equation}
	\label{rteintss}
	\begin{aligned}
		L(x, \vec{\omega}) =
		\tau(x_0, x) L(x_0, \vec{\omega}) + \int_{x_0}^{x} \tau(u, x) k_t(u) J_{SS}(u, \vec{\omega}) du
	\end{aligned}
\end{equation}

\subsection{Характеристики участвующей среды}
Таким образом, модель участвующей среды, характеризуется: плотностью частиц, коэффициентом поглощения $k_a$, коэффициентом рассеивания $k_s$ и фазовой функцией \cite{clouds}.

В отличие от поверхностей, чьи геометрические и оптические свойства можно рассматривать отдельно, определение геометрии и оптических свойств участвующих сред тесно связаны. Если коэффициент затухания или плотность частиц среды даны непосредственно как функция от координат, то эта функция определяет и геометрию \cite{partmedia}.  


\section{Методы представления облаков}
Методы представления облаков должны определять пространственное распределение плотности облаков на сцене.

Были рассмотрены следующие методы представления облаков:
\begin{itemize}
	\item система частиц;
	\item неявное представление;
	\item объемы, ограниченные поверхностью (англ. Surface-Bounded Volumes).
\end{itemize}

\subsection{Система частиц}
\label{particles}
Система частиц --- используемый в компьютерной графике способ представления объектов, не имеющих четких геометрических границ \cite{particles1}. 
Облако можно представить системой частиц \cite{voxel}. Каждая частица в системе задается своим положением в пространстве. Пусть $x$ --- некоторая точка в пространстве, $R$ --- заранее заданный радиус восприимчивости к частицам, $f(x)$ --- функция распределения плотности от расстояния до частицы. Тогда алгоритм определения плотности в точке $x$ будет состоять из следующих шагов.

\begin{enumerate}
	\item Найти все частицы, расстояние до которых от точки $x$ не больше заданного радиуса $R$.
	\item Вычислить расстояния от заданной точки $x$ до отобранных частиц.
	\item Для каждого вычисленного расстояния найти значений функции $f(x)$.
	\item Просуммировать полученные значения функций.
\end{enumerate}

Заметим, что выбор частиц в переделах заданного радиуса $R$ требует полного перебора всех частиц. Введение иерархических структур позволяет снизить количество частиц, которые необходимо рассмотреть для отбора требуемых.


\textbf{Воксельные октодеревья}

Октодерево --- древовидная структура данных, в которой у каждого внутреннего узла ровно восемь потомков \cite{octree}.
Каждый узел октодерева задает некоторый объем пространства, а каждый потомок этого узла описывает определенную октанту данного пространства. 
В родительском узле хранятся частицы, попавшие на границы октантов, а в дочернем узле частицы, принадлежащие октанту, который сопоставляется с данным дочерним узлом. Т.~о. для отбора частиц в радиусе $R$ достаточно рассмотреть, только частицы, принадлежащие определенному узлу дерева \cite{clouds}. 

\textbf{Двоичное разбиение пространства}

Двоичное разбиение пространства является методом рекурсивного разбиения пространства на выпуклые множества гиперплоскостями \cite{neighbours}. Каждая гиперплоскость сопоставляется с узлом дерева, что позволяет построить двочиное дерево. Списки частиц хранятся в листьях такого дерева. Выполняя поиск по такому дереву можно найти частицы, которые необходимо рассмотреть для отбора.

\textbf{Иерархия ограничивающих объёмов}

В данном методе группы частиц окружаются оболочками и выстраивается иерархия в виде древовидной структуры данных (двоичное BVH-дерево). По аналогии с двоичным разбиением пространства, для отбора частиц необходимо рассмотреть только те частицы, которые заключены в оболочку, которая сопоставляется с листовым узлом BVH-дерева \cite{clouds}.


\subsection{Объемы, ограниченные поверхностью} 
Облачный объем представляется окружающей его оболочкой, обычно заданной с помощью полигональной сетки. Полигональная сетка --- это совокупность вершин, рeбер и граней, которые определяют форму многогранного объекта в пространстве \cite{mesh}.

Поскольку информация о внутренней структуре облака отсутствует, то предполагается, что объем однородный. Тогда плотность в точке $x$ определяется по следующим шагам \cite{clouds}. 
\begin{enumerate}
	\item Проверить попала ли точка в какой-нибудь из ограниченных, заданных объемов.
	\item Если точка принадлежит объему, то плотность в этой точке, равна заданной плотности объема.
	\item Если точка не принадлежит ни одному объему, то плотность в этой точке равна 0.
\end{enumerate}

\subsection{Неявное представление} 
\label{implicit}
Распространенным способом представления поля плотности облаков является использование процедурных методов \cite{frostbite, hzd}. В то время как общая форма обычно задается простыми геометрическими объектами, такими как сферы или эллипсоиды, внутренняя структура с высоким разрешением генерируется процедурно \cite{clouds}. 

Для процедурной генерации могут использоваться функции шума, такие как: шум Перлина, шум Ворлея. 

\textbf{Шум Перлина} --- это градиентный шум, состоящий из набора псевдослучайных единичных векторов (направлений градиента), расположенных в определенных точках пространства и интерполированных функцией сглаживания, значений между этими точками \cite{perlin}.

\textbf{Шум Ворлея} --- это шум полученный инверсией шума Вороного. Для генерации шума Вороного необходимо создать регулярную сетку некоторого размера и разместить в центре каждой ячейки точку. Далее используя хеш-функцию, каждая точка смещается в пределах ячейки. Теперь, чтобы рассчитать шум для любого пикселя, нужно определить в какую ячейку он попадает и какие ячейки ему смежны. Далее проходя по всем ячейкам, определяется расстояние между пикселем и смещенными точками, значение шума Вороного --- минимальное из расстояний \cite{worley}. 

В итоге, для определения плотности в некоторой точке пространства, необходимо вычислить значение функции шума в данной точке. При этом, можно вычислить значения функции в некотором объеме заранее и хранить эти вычисления в памяти. Данный метод можно использовать в комбинации с полигональной сеткой \cite{implicit, hzd, frostbite, clouds}.


\subsection*{Вывод}

В таблице \ref{tbl:repr_choice} представлено сравнение способов представления облаков. По каждому параметру составлен рейтинг: 1 --- лучший способ, 3 --- худший.

Сравнение проводится для случая, когда необходимо заполнить небо облаками. Трудоемкость вычисления плотности оценивалась без учета предварительных вычислений.

В таблице \ref{tbl:repr_choice} введены следующие обозначения:
\begin{itemize}
	\item СЧ --- система частиц с использование октодеревьев;
	\item ООП --- объемы, ограниченные поверхностью;
	\item НП --- неявное представление, с предварительно вычисленными значениями функций шума.
\end{itemize} 

\begin{table}[h]
	\begin{center}
		\begin{threeparttable}
			\captionsetup{justification=raggedright,singlelinecheck=off}
			\caption{Сравнение методов представления облаков}
			\label{tbl:repr_choice}
			\begin{tabular}{|c|c|c|c|}
				\hline
				Характеристика &  СЧ  & ООП & НП \\
				\hline
				Реалистичность изображения &  1  & 3 & 1 \\
				\hline
				Трудоемкость вычисления плотности в точке &  3  & 2 & 1 \\
				\hline
				Требования по памяти & 2 & 1 & 3 \\
				\hline
			\end{tabular}
		\end{threeparttable}
	\end{center}
\end{table}

В результате для решения поставленной задачи был выбран метод неявного представления. Такой выбор обусловлен сравнительно низкой трудоемкостью.


\section{Анализ методов визуализации облаков}

Рассмотрим следующие алгоритмы рендеринга облаков:

\begin{itemize}
	\item алгоритм Сдвиг---Деформации (англ. Shear-Warp);
	\item разбрызгивание текстур (англ. Splatting);
	\item Ray Marching.
\end{itemize}


\subsection{Алгоритм Сдвиг---Деформации}
\label{slice}
Срез объема производится перпендикулярно каждой из главных осей или линии взгляда, и результирующая информация для каждого среза представляется в виде двумерной текстуры. Визуализация выполняется путем проецирования текстур и их смешивания в буфере кадра \cite{vs}. 

Нарезка объема плоскостями, ориентированными под углом, равным половине угла между направлением освещения и направлением взгляда, называется нарезкой по половинному углу (англ. Half-Angle Slicing). Такой подход позволяет совместить освещение и визуализацию объема в одном процессе путем однократной итерации по всем срезам. Во время этого единственного прохода объема поддерживаются и итеративно обновляются два буфера: один для накопления ослабления яркости в направлении распространения света, а другой для накопления яркости для наблюдателя. Из-за однократного прохождения через объем схема освещения ограничивается либо прямым, либо обратным рассеянием \cite{clouds}. 

Чтобы избежать появления артефактов, рекомендуется использовать множество срезов с малым шагом, что может привести к снижению производительности рендеринга. Передача сложной геометрии объема также может потребовать большого количества срезов. Следовательно, методы, основанные на срезах, предпочтительны для объемов с мягкими или размытыми границами, однако их применимость ограничена в случае, когда объем имеет резкие границы \cite{clouds}.

\subsection{Разбрызгивание текстур}
\label{splatting}
Разбрызгивание стало распространенным методом рендеринга систем частиц. Частицы, которые обычно определяются как независимые от вращения, могут быть визуализированы с помощью текстурированного четырехугольника, представляющего проекцию частицы на плоскость, также называемую <<пятном>> или <<отпечатком>> (от англ. splat и footprint соответственно). Частицы визуализируются в обратном порядке, применяя смешивание текстур в буфере кадра \cite{voxel, clouds}. 

Частицы представляют некоторый сферический, рассеивающий объем, а не четкий геометрический объект, поэтому этот метод подходит для визуализации облаков с мягкими, пушистыми формами. Облака с четкой геометрией поверхности, такие как кучевые облака, не могут быть воспроизведены реалистично.


\subsection{Ray Marching}
\label{ray}
Ray Marching бросает лучи в сцену и накапливает объемную плотность через определенные интервалы. Для визуализации облаков, нужно учесть освещение, это можно сделать либо применив модель освещения во время трассировки, либо путем извлечения значений из предварительно вычисленной структуры данных освещения \cite{hzd, frostbite, clouds}.

Ray Marching позволяет достичь более реалистичного рендеринга облаков, поскольку он учитывает сложные внутренние структуры объема и свойства облака. Он также способен обрабатывать более сложные геометрические формы облаков, такие как кучевые облака.

\subsection{Выбор метода визуализации}
Для визуализации неявно представленных облаков применяется метод Ray Marching, поскольку поле плотности в таких облаках задается текстурой, а не системой частиц или регулярной сеткой. Хоть данный алгоритм медленнее других, рассмотренных выше, он позволяет учесть некоторые важные физические явления, происходящие в облаках и получить кадр более высокого качества.


\section{Модель освещения}

Для реалистичной визуализации облаков, модель освещения должна аппроксимировать следующие эффекты: множественное рассеяние и направленное освещение в облаках, <<серебряное обрамление>> (эффект возникающий, когда мы смотрим на солнце через облака), и темные границы облака, когда мы смотрим на облако в направлении от солнца. 

Как было описано в пункте \ref{math}, с фотоном попавшим в облако, может произойти три события:
\begin{enumerate}
	\item он может поглотиться частицей воды или другой частицей, не относящейся к облаку, например пылью;
	\item в ходе отражений, он выходит из облака и движется в сторону наблюдателя. Назовем это внутренним рассеянием;
	\item в ходе отражений, он выходит из облака и движется в сторону противоположную от наблюдателя. Назовем это внешним рассеянием.
\end{enumerate}
Закон Бера \eqref{beers_law} является стандартным методом для аппроксимации вероятности каждого из этих трех явлений. Т.~к. облака являются неоднородной средой, мы должны накапливать оптическую плотность вдоль луча. Тогда, приближенно, считаем энергию накопленную лучом:
\begin{equation}
	\label{bl}
	BL = e ^ {-d}
\end{equation}
где $ d $ -- накопленная оптическая плотность.


Для моделирования явления <<серебряного обрамления>>, используются фазовые функции, одной из которых, является функция Хеньи-Гринштейна \eqref{HG}.

Закон Бера -- это модель поглощения, а это означает, что он описывает то, как световая энергия поглощается при распространении вглубь облака. Но такая модель не учитывает важный световой эффект, который связан с внутренним рассеянием на обращенных к солнцу сторонах облаков. Этот эффект проявляется в виде темных краев на облаках, когда направление луча обзора приближается к направлению луча света. Этот эффект наиболее заметен в круглых, плотных областях облаков, настолько, что складки между каждой выпуклостью кажутся ярче, чем сама выпуклость, которая находится ближе к солнцу. Эти результаты кажутся полной противоположностью тому, что моделирует закон Бера.  Напомним, что большее количество света рассеивается вперед, вдоль исходного направления светового луча из-за прямого рассеяния. Должна существовать относительно большая оптическая толщина, чтобы фотон мог повернуться на 180 градусов. Пути около границы облака не проходят через достаточно большую оптическую толщину, чтобы полностью обернуть заметную часть фотонов. Пути, которые имеют оптическую толщину, достаточную для поворота фотона на 180 градусов, почти всегда находятся внутри облака, поэтому закон Бера заглушит этот вклад до того, как частица света покинет облако. Щели и трещины являются исключением, они создают <<окно>>, через которое фотоны могут покинуть облако по пути с малой плотностью, делая расщелины ярче, чем окружающие их выпуклости. Для учета этого эффекта в закон Бера вносят поправку:

\begin{equation}
	\label{sugar_powder}
	PSE = 1 - e ^ {-2 d}
\end{equation}

Приближено, считаем световую энергию, накопленную лучом, таким образом:
\begin{equation}
	\label{bsp}
	LE = 2 * BL * PSE
\end{equation}
где $ LE $ - накопленная энергия света. 

В итоге, полностью наша модель освещения описывается следующим образом:
\begin{equation}
	\label{light_model}
	E = 2 * e ^ {-d} * (1 - 2 e ^ {-2d}) * \frac{1}{4\pi} \frac{1 - g^2}{(1 + g^2 - 2g\cos \theta)^{3/2}}
\end{equation}
где $ g $ -- некоторая константа в функции Хеньи-Гринштейна, а $ \theta $ -- угол между лучами взгляда и света.

\subsection{Расчет освещения}
Очевидный способ найти количество падающего света -- измерить переносимую световую энергию внутри облака между рассматриваемой точкой и солнцем. Однако на освещенность любой точки облака сильно влияет освещенность в областях вокруг нее в направлении источника света, т.~е. нам необходимо рассмотреть конус с вершиной в рассматриваемой точке. Внутри конуса мы выбираем случайным образом, некоторое количество точек, в которых рассчитываем плотность. Суммируя плотности в точках, мы получаем плотность накопленную в конусе, далее используем ее, чтобы вычислить световую энергию в рассматриваемой точке.

Для более грубого расчета освещения, можно накапливать плотность не внутри конуса, а в точках на луче, который начинается в освещаемой точке и направлен к источнику света. 


%%% --------------------------------- COMMENTED -----------------------------
\mycomment{
	\section{Техники освещения}
	
	\subsection{Аппроксимация однократного рассеивания}
	\begin{itemize}
		\item На основе срезов: нарезанный объем используется для создания объемной карты освещения, хранящей яркость света. Этот так называемый <<световой объем>> ориентирован так, что свет проходит перпендикулярно или параллельно срезам из которых он состоит, что обеспечивает прямое распространение света от среза к срезу \cite{schpok};
		\item На основе частиц. Используется отбрасывания теней в качестве аппроксимации однократного рассеяния для освещения системы частиц. Сцена преобразуется таким образом, чтобы точка наблюдения совпала с источником света. Кадровый буфер графического процессора используется в качестве карты теней. Частицы сортируются и обрабатываются в направлении спереди назад относительно источника света. Для каждой частицы значение тени рассчитывается с помощью коэффициента затухания, который в свою очередь рассчитывается итеративно, т.~е. коэффициент затухания в некоторой частице равен произведению коэффициентов всех частиц, через который прошел свет на пути к данной частице \cite{voxel}.
	\end{itemize}
	
	\subsection{Диффузия света}
	
	В оптически плотных средах, когда свет сталкивается с множеством частиц, диффузия является допустимым приближением для описания распределения света внутри таких сред. Однако это приближение становится менее точным в неоднородных средах или на их границах. 
	Возможно комбинировать диффузию с анизотропным рассеиванием, чтобы учитывать неоднородности в среде, например, чтобы воспроизвести такой эффект, как <<серебряное обрамление>> (англ. silver-lining) в облаках. <<Серебряное обрамление>> - это светящаяся граница облаков, которая может наблюдаться при правильных условиях освещения.
	Таким образом, данная модель может быть эффективной для создания более реалистичных визуальных эффектов в облаках, но требует значительных вычислительных ресурсов и рендеринг может занимать несколько часов \cite{clouds}.
	
	
	\subsection{Трассировка пути}
	
	Подход заключается в том, что для каждого пикселя на изображении запускаются сотни или даже тысячи лучей в сцену, которые отслеживаются до тех пор, пока они не достигнут источника света или не будут отражены обратно в камеру. Метод <<Трассировки пути>> обеспечивает физически корректные результаты, но, как правило, страдает от шума и низкой скорости работы.
	
	Различные структуры данных используются для разделения объемных данных на подмножества для эффективного обхода и отслеживания лучей. В качестве таких структур данных могут выступать kd-деревья или регулярные сетки. Такие ускоренные методы позволяют сократить время рендеринга и снизить уровень шума, делая метод <<Трассировки пути>> более применимым для сложных объемных данных, таких как облака, и позволяют получить более качественные и реалистичные результаты \cite{clouds}.
	
	\subsection{Фотонные карты}
	
	Фотоны в данном методе — это частицы, переносящие некоторую дискретную порцию световой энергии. На начальном этапе фотоны испускаются из источника света в соответствии с распределением световой энергии у данного источника. Например известно, что точечный или сферический источник света испускают свет изотропно во всех направлениях. В  процессе  трассировки  фотоны  ударяются  о  различные  поверхности  сцены.  В 
	зависимости от свойств материала поверхности, с ними могут происходить разные события: 
	прохождение через поверхность, полное поглощение, зеркальное отражение либо диффузное отражение. При  взаимодействии  фотона  с  диффузным  объектом  запись  о  фотоне 
	сохраняется в обычном списке или массиве. 
	
	После  завершения  трассировки  фотонов  необходимо  произвести  непосредственно 
	построение  фотонной  карты,  которая  представляет  собой  специальную  структуру 
	распределения  фотонов  на  поверхностях  сцены.  Данный  этап  позволяет  избежать 
	значительных вычислительных затрат, поскольку если бы фотоны просто сохранялись в виде 
	массива  или  списка,  то  k  ближайших  фотонов  к  текущему  каждый  раз  приходилось  бы 
	вычислять перебором, что значительно снижает быстродействие алгоритма. Для хранения фотонов используется kd-дерево.
	
	Далее применяется обычная трассировка лучей из камеры, но в местах пересечения лучей с объектами находятся k ближайших фотонов, их энергия суммируется и делится на площадь сферы с радиусом равным расстоянию да самого дальнего из этих фотонов. Полученная величина добавляется к общей энергии собранной лучом. Важным  достоинством  метода  фотонных  карт  является  тот  факт,  что  расчеты  не 
	зависят  от  положения  камеры,  что  позволяет во  многих  случаях  рассчитать  освещенность 
	всего  один  раз \cite{photon}.
	
	\subsection{Глобальная модель освещения}
	
	Для реализации явлений межоблачного затенения и непрямого освещения используется глобальная модель освещения.
	
	Представление объектов сцены с помощью сфер, позволяет быстро вычислять тени, например, используя сферические функции, или путем накопления теней в пространстве изображения \cite{clouds}.
	
	Непрямое освещение: освещенность точки на поверхности оценивается с помощью освещенности соседних точек в нескольких направлениях, ограниченных конусами.
}




%%% --------------------------------- COMMENTED -----------------------------
\mycomment{
	\section{Существующие примеры моделирования объемных облаков}
	
	Использование процедурной генерации описанной в пункте \ref{implicit}, считается современным стандартом моделирования облаков в компьютерных играх и фильмах. Этот метод применялся в:
	\begin{itemize}
		\item Компьютерной игре <<Horizon Zero Dawn>> \cite{hzd};
		\item Игровом движке Frostbite \cite{frostbite};
	\end{itemize}
	
	\img{75mm}{hzdimg}{Облака созданные с помощью процедурной генерации и погодных карт в игре <<Horizon Zero Dawn>>}
}


\section*{Вывод}

В данном разделе был проведен анализ способов хранения поля плотности облаков, методов визуализации и модели освещения, которые возможно использовать для решения поставленных задач. В итоге была выбрана связка из неявного представления облаков с алгоритмом Ray Marching, так как такой подход позволяет достичь высокой реалистичности, а также точности построенного изображения. 








