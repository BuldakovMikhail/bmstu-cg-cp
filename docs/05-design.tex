\chapter{Конструкторский раздел}

В данном разделе представлены требования к программному обеспечению, а также схемы алгоритмов, выбранных для решения поставленной
задачи.

\section{Требования к программному обеспечению}
Программа должна обладать следующей функциональностью:
\begin{itemize}
	\item задать направление взгляда камеры;
	\item изменить направление лучей света;
	\item варьировать параметры облачного неба.
\end{itemize}

Программа должна корректно реагировать на любые действия пользователя.

\section{Разработка алгоритмов}

Для повышения эффективности алгоритма Ray Marching необходимо снизить количество шагов вне облака. 
Для этого применяются объемлющие оболочки, в данном случае, такими оболочками будут являться сферы.
Когда луч пересекает оболочку, необходимо сделать $ N $ шагов, на каждом из которых вычисляется плотность в точке пространства и ее освещенность, используя эти данные итеративно вычисляется значение цвета пикселя. 

Как показано на рисунке~\ref{img:earth}, атмосфера будет моделироваться с помощью двух концентрических сфер, между которыми и будет происходить генерация облаков.

\includeimage
{earth} % Имя файла без расширения (файл должен быть расположен в директории inc/img/)
{f} % Обтекание (без обтекания)
{H} % Положение рисунка (см. figure из пакета float)
{0.7\textwidth} % Ширина рисунка
{Схема атмосферы и положения наблюдателя} % Подпись рисунка


\subsection{Пересечение луча со сферой}

Уравнение луча записывается следующим образом:

\begin{equation}
	\label{ray_eq}
	P = S + t \vec{D}, t \ge 0,
\end{equation}
где $ S $ --- точка, откуда луч испускается, а $ \vec{D} $ --- направление луча.

Сфера задается своим центром $ C $ и радиусом $ r $. Если луч пересекает сферу, тогда точка $ P $ лежит на поверхности:
\begin{equation}
	\label{ray_intersec_sp}
	\| P - C \| = r.
\end{equation}

Используя скалярное умножение~\eqref{ray_intersec_sp} записывается следующим образом:
\begin{equation}
	\label{ray_intersec_sp2}
	\sqrt{\langle P - C , P - C \rangle} = r.
\end{equation}

Подставляя в~\eqref{ray_intersec_sp2} уравнение луча~\eqref{ray_eq}, получается:

\begin{equation}
	\label{ray_intersec_sp3}
	\sqrt{\langle S + t \vec{D} - C , S + t \vec{D} - C \rangle} = r.
\end{equation}

Обозначив $ S - C = \vec{SC} $ и раскрыв скалярное произведение, возведя обе части уравнения~\eqref{ray_intersec_sp3} в квадрат, получается:

\begin{equation}
	\label{ray_intersec_sp4}
	t ^ 2 \langle \vec{D}, \vec{D} \rangle + 2t \langle \vec{SC}, \vec{D} \rangle + \langle \vec{SC}, \vec{SC} \rangle - r ^ 2 = 0.
\end{equation}

Решая квадратное уравнение~\eqref{ray_intersec_sp4}, вычисляются точки пересечения луча со сферой.

\subsection{Вычисление плотности облаков в атмосфере}

Для вычисления плотности будут использоваться две текстуры.
Первая (основная) текстура отвечает за грубую форму облака, имеет размер $ 128 \times 128 \times 128 $. Вторая (вспомогательная) текстура отвечает за детализацию облака, имеет размер $ 32 \times 32 \times 32$. 
В таблице~\ref{tab:textures} показаны какие шумы используются для формирования текстур.


\begin{table}[h]
	\centering
	\begin{threeparttable}
		\captionsetup{justification=raggedleft,singlelinecheck=false}
		\caption{Таблица шумов.}      
		\begin{tabular}{|c|c|c|c|c|}
			\hline
			Текстура & \multicolumn{4}{c|}{Шумы} \\
			\hline
			Основная & ПВ (НЧ) & В (НЧ) & В (СЧ) & В (ВЧ)\\
			\hline
			Вспомогательная & В (НЧ) & В (СЧ) & В (ВЧ) & -\\
			\hline
		\end{tabular}
		\begin{tablenotes}
			\small
			\item Примечание: ПВ --- шум Перлина---Ворлея, В --- шум Ворлея, НЧ --- низкая частота, СЧ --- средняя частота, ВЧ --- высокая частота.
		\end{tablenotes}
		\label{tab:textures}
	\end{threeparttable} 
	
	
\end{table}

Сами текстуры формируются как сумма перечисленных в таблице~\ref{tab:textures} шумов с убывающими амплитудами.

Для возможности формировать облачное небо используется погодная карта. Погодная карта является двумерной текстурой, и состоит из четырех каналов RGBA, где в R канале хранится коэффициент покрытия неба облаками на малой высоте, G хранит покрытие облаками на большой высоте, B канал хранит максимальную высоту облаков, A канал хранит коэффициент плотности облаков. 

\subsection{Схемы алгоритмов}

На рисунке~\ref{img:level1} изображена диаграмма генерации кадра.

\includeimage
{level1} % Имя файла без расширения (файл должен быть расположен в директории inc/img/)
{f} % Обтекание (без обтекания)
{H} % Положение рисунка (см. figure из пакета float)
{1\textwidth} % Ширина рисунка
{Диаграмма генерации кадра} % Подпись рисунка

Схема алгоритма Ray Marching приведена на рисунке~\ref{img:renderscheme1}. Алгоритм вычисления плотности в точке изображен на рисунке~\ref{img:density}. Алгоритм вычисления яркости в точке изображен на рисунке~\ref{img:light}.


\includeimage
{renderscheme1} % Имя файла без расширения (файл должен быть расположен в директории inc/img/)
{f} % Обтекание (без обтекания)
{H} % Положение рисунка (см. figure из пакета float)
{1\textwidth} % Ширина рисунка
{Схема визуализации облаков с помощью алгоритма Ray Marching} % Подпись рисунка


\includeimage
{density} % Имя файла без расширения (файл должен быть расположен в директории inc/img/)
{f} % Обтекание (без обтекания)
{H} % Положение рисунка (см. figure из пакета float)
{0.9\textwidth} % Ширина рисунка
{Схема вычисления плотности в точке} % Подпись рисунка

\includeimage
{light} % Имя файла без расширения (файл должен быть расположен в директории inc/img/)
{f} % Обтекание (без обтекания)
{H} % Положение рисунка (см. figure из пакета float)
{0.8\textwidth} % Ширина рисунка
{Схема вычисления яркости в точке} % Подпись рисунка

\section{Диаграмма классов}

На рисунке~\ref{img:classdiagram} изображена диаграмма классов программного обеспечения.

\includeimage
{classdiagram} % Имя файла без расширения (файл должен быть расположен в директории inc/img/)
{f} % Обтекание (без обтекания)
{H} % Положение рисунка (см. figure из пакета float)
{1\textwidth} % Ширина рисунка
{Диаграмма классов программного обеспечения} % Подпись рисунка


\section{Выбор используемых типов и структур данных}

В данной работе используются следующие типы и структуры данных:
\begin{itemize}
	\item текстура --- задается с помощью двумерных и трехмерных массивов, состоящих из цветов;
	\item цвет --- хранит одну, три или четыре составляющие grayscale, RGB или RGBA модели цвета соответственно;
	\item точка --- хранит координаты x, y, z;
	\item вектор --- хранит направление по x, y, z.
\end{itemize}


\section*{Вывод}
В данном разделе были представлены требования к разрабатываемому
программному обеспечению и разработана схема разрабатываемых алгоритмов.
Так же, были описаны структуры данных, которые будут использоваться при реализации программного обеспечения.

