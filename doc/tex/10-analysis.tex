\chapter{Аналитическая часть}

\section{Участвующая среда}

Участвующая среда -- термин используемый для описания объемов заполненных частицами. Этими частицами могут являться: капли воды, кристаллы льда, пыль, молекулы. Проходя через такую среду, свет взаимодействует с частицами и может отражаться, поглощаться или рассеиваться \cite{frostbite}.  

\subsection{Закон Бугера — Ламберта — Бера}
Частицы, находящиеся в облаке, проводят и отражают свет, поэтому облако
сильно отличается от твердых объектов и является поглощающей средой.
Закон Бугера — Ламберта — Бера – определяет ослабление пучка света при распространении его в поглощающей среде. 
Свет, проходя сквозь вещество, подвергается поглощению этим самым веществом. Для дифференциального расстояния $ dx $ относительное уменьшение яркости определяется как $ k_a(x)dx $, где $ k_a(x) $ - коэффициент поглощения среды в точке x. Часть света под воздействием частиц вещества меняет свое направление. Доля рассеянного света определяется как $ k_s(x)dx $, где $ k_s(x) $ - коэффициент рассеивания. Тогда введем коэффициент затухания $ k_t(x)  = k_a(x) + k_s(x) $, яркость в точке $x$ находится следующим образом (Закон Бугера — Ламберта — Бера):  
\begin{equation}
	\label{beers_law}
	L(x) = L(x_0) e^{-\int_{x_0}^{x} k_t(u)\,du}=L(x_0)\tau(x_0, x) 
\end{equation}
где $ L(x) $ - яркость в точке $ x $. Функцию $ \tau(x_0, x) = e^{-\int_{x_0}^{x} k_t(u)\,du}  $ называют передаточной функцией, она показывает какая доля света останется при прохождении из точки $ x_0 $ в точку $ x $ \cite{partmedia}.

\subsection{Фазовая функция}
Чтобы вывести уравнение переноса (англ. transport equation), необходимо учитывать увеличение яркости из-за эмиссии и рассеивания света в направлении распространения луча. Пространственное распределение рассеянного света моделируется фазовой функцией $ p(\vec{\omega}, \vec{\omega}') $. Фазовая функция имеет физическую интерпретацию как интенсивность рассеяния в направлении $\vec{\omega}$, деленная на интенсивность, которая была бы рассеяна в этом направлении, если бы рассеяние было изотропным (т.е. независимым от направления). Фазовые функции в компьютерной графике обычно симметричны относительно направления падения, поэтому их можно параметризовать углом между входящим и исходящим лучами. В качестве фазовой функции для облаков используется функция Хеньи — Гринштейна \eqref{HG}:
\begin{equation}
	\label{HG}
	p(\theta) = \frac{1}{4\pi} \frac{1 - g^2}{(1 + g^2 - 2g\cos \theta)^{3/2}}
\end{equation}
где $ g $ - варьируемый параметр, причем $ -1 \leq g \leq 1 $, а $\theta$ - угол между входящим и исходящим лучами \cite{clouds}.

\subsection{Уравнение переноса}
Уравнение переноса описывает изменение яркости внутри участвующей среды в точке $ x $:
\begin{equation}
	\label{rte}
	\begin{aligned}
		\frac{dL(x, \vec{\omega})}{dx} = & k_t(x) J(x, \vec{\omega}) - k_t(x) L(x, \vec{\omega})  = \\
		 & k_a(x) L_e(x, \vec{\omega}) + \frac{k_s(x)}{4\pi} \int_{4\pi} p(\vec{\omega}', \vec{\omega}) L(x, \vec{\omega}') d\omega' - \\
		& k_a(x) L(x, \vec{\omega}) - k_s(x) L(x, \vec{\omega})	
	\end{aligned}
\end{equation}
где $ L_e(x, \vec{\omega}) $ - яркость выделенного света (эмиссии), а $ J(x, \vec{\omega}) $ - вносимая яркость. Стоит заметить, что явление эмиссии не относится к облакам, т.~к. в облаках не наблюдается люминесценция.    
 
Используя альбедо однократного рассеяния $ \Omega = \frac{k_s}{k_t} $, мы можем записать вносимую яркость $J$, как:
\begin{equation}
	\label{sourcerad}
	\begin{aligned}
		J(x, \vec{\omega}) = \underbrace{(1 - \Omega(x)) L_e(x, \vec{\omega})}_{J_e(x, \vec{\omega})} + \frac{\Omega(x)}{4\pi} \int_{4\pi} p(\vec{\omega}', \vec{\omega}) L(x, \vec{\omega}') d\omega'
	\end{aligned}
\end{equation}
Вносимая яркость описывает вклады яркости в луч $ (x, \vec{\omega}) $ в точке $ x $ внутри среды, которые обуславливаются эмиссией света и рассеянными в рассматриваемом направлении лучами. 

Проинтегрировав уравнение переноса \ref{rte}, получим:
\begin{equation}
	\label{rteint}
	\begin{aligned}
		L(x, \vec{\omega}) =
		\underbrace{\tau(x_0, x) L(x_0, \vec{\omega})}_{L_{ri}(x, \vec{\omega})} + \underbrace{\int_{x_0}^{x} \tau(u, x) k_t(u) J(u, \vec{\omega}) du}_{L_m(x, \vec{\omega})}
	\end{aligned}
\end{equation}
где $ L_{ri}(x, \vec{\omega}) $ - яркость падающего света, а $ L_m(x, \vec{\omega}) $ - яркость, обусловленная явлениями внутри среды. 

Целью алгоритмов рендеринга является разрешение уравнения \ref{rteint}, по крайней мере для точек видимых относительно камеры \cite{partmedia}. 

\subsection{Однократное рассеивание}

Сложность решения \ref{rteint} заключается в том, что $L$ появляется в обеих частях уравнения (неявно через $J$). Приближенное решение состоит в том, чтобы учитывать только определенное количество событий рассеяния и рассчитывать затухание луча на промежутках между этими событиями. Считаем вклад яркости за счет явлений в среде равным нулю, тогда:
\begin{equation}
	\label{jss}
	\begin{aligned}
		J(x, \vec{\omega}) \approx J_{SS}(x, \vec{\omega}) = J_e(x, \vec{\omega}) + \frac{\Omega(x)}{4\pi} \int_{4\pi} p(\vec{\omega}', \vec{\omega}) L_{ri}(x, \vec{\omega}') d\omega'
	\end{aligned}
\end{equation}

C учетом \ref{jss} и \ref{rteint}, получаем:
\begin{equation}
	\label{rteintss}
	\begin{aligned}
		L(x, \vec{\omega}) =
		\tau(x_0, x) L(x_0, \vec{\omega}) + \int_{x_0}^{x} \tau(u, x) k_t(u) J_{SS}(u, \vec{\omega}) du
	\end{aligned}
\end{equation}

\subsection{Способы представления участвующей среды}
Таким образом, модель участвующей среды, характеризуется: плотностью частиц, коэффициентом поглощения $k_a$, коэффициентом рассеивания $k_s$ и фазовой функцией \cite{clouds}.

В отличие от поверхностей, чьи геометрические и оптические свойства можно рассматривать отдельно, определение геометрии и оптических свойств участвующих сред тесно связаны. Если коэффициент затухания или плотность частиц среды даны непосредственно как функция координат, то эта функция определяет и геометрию \cite{partmedia}.  


\section{Способы представления облаков}

Представить объемные облака можно следующими способами:
\begin{itemize}
	\item Система частиц;
	\item Набор вокселей;
	\item Объемы, ограниченные поверхностью (англ. Surface-Bounded Volumes);
\end{itemize}

\subsection{Система частиц}
\label{particles}
Система частиц - используемый в компьютерной графике способ представления объектов, не имеющих четких геометрических границ \cite{particles1}. 
Облако представляется набором частиц с заранее заданным объемом. Обычно используются сферические частицы с радиальной функцией плотности. Т.~к. с физической точки зрения облако и есть взвешенные в атмосфере частицы воды и/или льда, то 
облака, которые моделируются системой частиц ведут себя достаточно реалистично. В зависимости от задачи, можно вводить различные правила взаимодействия частиц.
Такой подход позволяет моделировать затухание и рождение облака. Но для моделирования одного облака необходимо большое количество частиц, что означает высокие вычислительные затраты и как следствие, визуализиация облачного неба в режиме реального времени, является сложной задачей.  

\subsection{Набор вокселей} 

Воксель - элемент объемного изображения, содержащий значение элемента растра в трехмерном пространстве.
Представление облака с помощью вокселей позволяет использовать клеточные автоматы для создания анимаций. При этом необходимо все пространство моделирования разделить на воксели. Воксели
соответствуют ячейкам, используемым в клеточном автомате и содержат информацию о своих свойствах, таких как плотность, цвет и освещение. Эволюция облака моделируется путем
применения простых правил перехода на каждом временном шаге. Правила перехода представляют собой формирование, исчезновение и адвекцию облака ветрами.
Такой подход позволяет создавать реалистично выглядящие и ведущие себя облака. Но по-прежнему, создание облачного неба, требует большое количество ресурсов, для хранения и вычисления состояний вокселей, что делает сложным моделирование неба в режиме реального времени \cite{voxel}.

\subsection{Объемы, ограниченные поверхностью} 
\label{partmediaref}
Распространенным способом моделирования и представления облаков является использование процедурных методов. Облачный объем представляется окружающей его оболочкой, обычно заданной с помощью полигонов. Использование оболочки комбинируется с использованием шумовых функций для добавления мелких деталей на поверхности облака. Внутреннее распределение плотности может храниться в заранее заготовленных картах или вычисляться на лету с помощью шумов \cite{frostbite}. Такой подход позволяет эффективно выполнять визуализацию облаков и использовать сложные системы освещения \cite{clouds}. 


\section{Анализ методов визуализации облаков}

Рассмотрим следующие методы рендеринга облаков:

\begin{itemize}
	\item Срез объема (англ. Volume slicing);
	\item Разбрызгивание текстур (англ. Splatting);
	\item Ray marching;
\end{itemize}


\subsection{Срез объема}
\label{slice}
Срез объемов - это простой метод рендеринга регулярных сеток. Срезы объема производятся перпендикулярно каждой из главных осей или линии взгляда, и результирующая информация для каждого среза представляется в виде 2D-текстуры. Рендеринг выполняется путем проецирования текстур и их смешивания в буфере кадра \cite{vs}. Нарезка объема плоскостями, ориентированными под углом, равным половине угла между направлением освещения и направлением взгляда, называется нарезкой по половинному углу (англ. Half-Angle Slicing). Такой подход позволяет совместить освещение и визуализацию объема в одном процессе путем однократной итерации по всем срезам. Во время этого единственного прохода объема поддерживаются и итеративно обновляются два буфера: один для накопления ослабления яркости в направлении света, а другой для накопления яркости для наблюдателя. Из-за однократного прохождения через объем схема освещения ограничивается либо прямым, либо обратным рассеянием \cite{clouds}. 

Чтобы избежать появления артефактов, рекомендуется использовать множество срезов с малым шагом, что может привести к снижению производительности рендеринга. Передача сложной геометрии объема также может потребовать большого количества срезов. Следовательно, методы, основанные на срезах, предпочтительны для объемов с мягкими или размытыми границами, однако их применимость ограничена в случае, когда объем имеет резкие границы.

\subsection{Разбрызгивание текстур}
\label{splatting}
Разбрызгивание стало распространенным методом рендеринга систем частиц. Частицы, которые обычно определяются как независимые от вращения, могут быть визуализированы с помощью текстурированного четырехугольника, представляющего проекцию частицы на плоскость, также называемую <<пятном>> или <<отпечатком>> (от англ. splat и footprint соответственно). Частицы визуализируются в обратном порядке, применяя смешивание текстур в буфере кадра \cite{voxel, clouds}. 

Частицы представляют некоторый сферический, рассеивающий объем, а не четкий геометрический объект, использование метода <<разбрызгивания текстур>> ограничено.  Этот метод подходит для визуализации облаков с мягкими, пушистыми формами. Облака с четкой геометрией поверхности, такие как кучевые облака, не могут быть воспроизведены реалистично.


\subsection{Ray marching}
\label{ray}
Ray marching бросает лучи в сцену и накапливает объемную плотность через определенные интервалы. Для визуализации облаков, нужно учесть освещение, это можно сделать либо на лету применив модель освещения, либо путем извлечения значений из предварительно вычисленной структуры данных освещения \cite{hzd, frostbite, clouds}.

Ray marching позволяет достичь более реалистичного рендеринга облаков, поскольку он учитывает сложные внутренние структуры объема и свойства облака. Он также способен обрабатывать более сложные геометрические формы облаков, такие как кучевые облака.


\section{Техники освещения}

\subsection{Аппроксимация однократного рассеивания}
\begin{itemize}
	\item На основе срезов: нарезанный объем используется для создания объемной карты освещения, хранящей яркость света. Этот так называемый <<световой объем>> ориентирован так, что свет проходит перпендикулярно или параллельно срезам из которых он состоит, что обеспечивает прямое распространение света от среза к срезу \cite{schpok};
	\item На основе частиц или вокселей: отбрасывание теней как метод однократного рассеяния для освещения системы частиц. Сцена визуализируется с точки зрения источника света, используя кадровый буфер графического процессора в качестве карты теней. Частицы сортируются и обрабатываются в направлении спереди назад относительно источника света. Для каждой частицы значение тени рассчитывается с помощью коэффициента затухания, который в свою очередь рассчитывается итеративно, т.~е. коэффициент затухания в некоторой частице равен произведению коэффициентов всех частиц, через который прошел свет на пути к данной частице \cite{voxel};
\end{itemize}

\subsection{Диффузия света}

 В оптически плотных средах, когда свет сталкивается с множеством частиц, диффузия является допустимым приближением для описания распределения света внутри таких сред. Однако это приближение становится менее точным в неоднородных средах или на их границах. 
 Возможно комбинировать диффузию с анизотропным рассеиванием, чтобы учитывать неоднородности в среде, например, чтобы воспроизвести такой эффект, как <<серебряное обрамление>> (англ. silver-lining) в облаках. <<Серебряное обрамление>> - это светящаяся граница облаков, которая может наблюдаться при правильных условиях освещения.
 Таким образом, данная модель может быть эффективной для создания более реалистичных визуальных эффектов в облаках, но требует значительных вычислительных ресурсов и рендеринг может занимать несколько часов \cite{clouds}.


\subsection{Трассировка пути}

Подход заключается в том, что для каждого пикселя на изображении запускаются сотни или даже тысячи лучей в сцену, которые отслеживаются до тех пор, пока они не достигнут источника света или не будут отражены обратно в камеру. Метод <<Трассировки пути>> обеспечивает физически корректные результаты, но, как правило, страдает от шума и низкой скорости работы.

Различные структуры данных используются для разделения объемных данных на подмножества для эффективного обхода и отслеживания лучей. В качестве таких структур данных могут выступать kd-деревья или регулярные сетки. Такие ускоренные методы позволяют сократить время рендеринга и снизить уровень шума, делая метод <<Трассировки пути>> более применимым для сложных объемных данных, таких как облака, и позволяют получить более качественные и реалистичные результаты \cite{clouds}.

\subsection{Фотонные карты}

Фотоны в данном методе — это частицы, переносящие некоторую дискретную порцию световой энергии. На начальном этапе фотоны испускаются из источника света в соответствии с распределением световой энергии у данного источника. Например известно, что точечный или сферический источник света испускают свет изотропно во всех направлениях. В  процессе  трассировки  фотоны  ударяются  о  различные  поверхности  сцены.  В 
зависимости от свойств материала поверхности, с ними могут происходить разные события: 
прохождение через поверхность, полное поглощение, зеркальное отражение либо диффузное отражение. При  взаимодействии  фотона  с  диффузным  объектом  запись  о  фотоне 
сохраняется в обычном списке или массиве. 

После  завершения  трассировки  фотонов  необходимо  произвести  непосредственно 
построение  фотонной  карты,  которая  представляет  собой  специальную  структуру 
распределения  фотонов  на  поверхностях  сцены.  Данный  этап  позволяет  избежать 
значительных вычислительных затрат, поскольку если бы фотоны просто сохранялись в виде 
массива  или  списка,  то  k  ближайших  фотонов  к  текущему  каждый  раз  приходилось  бы 
вычислять перебором, что значительно снижает быстродействие алгоритма. Для хранения фотонов используется kd-дерево.

Далее применяется обычная трассировка лучей из камеры, но в местах пересечения лучей с объектами находятся k ближайших фотонов, их энергия суммируется и делится на площадь сферы с радиусом равным расстоянию да самого дальнего из этих фотонов. Полученная величина добавляется к общей энергии собранной лучом. Важным  достоинством  метода  фотонных  карт  является  тот  факт,  что  расчеты  не 
зависят  от  положения  камеры,  что  позволяет во  многих  случаях  рассчитать  освещенность 
всего  один  раз \cite{photon}.

\subsection{Глобальная модель освещения}

Для реализации явлений межоблачного затенения и непрямого освещения используется глобальная модель освещения.

Представление объектов сцены с помощью сфер, позволяет быстро вычислять тени, например, используя сферические функции, или путем накопления теней в пространстве изображения \cite{clouds}.

Непрямое освещение: освещенность точки на поверхности оценивается с помощью освещенности соседних точек в нескольких направлениях, ограниченных конусами.

\section{Процедурная генерация облаков}

\subsection{Шум Ворлея}

Для генерации шума Ворлея необходимо создать регулярную сетку некоторого размера и разместить в центре каждой ячейки точку. Далее используя хеш-функцию, мы сдвигаем каждую точку в пределах ячейки. Теперь, чтобы рассчитать шум для любого пикселя, нужно определить в какую ячейку он попадает и какие ячейки смежны. Далее проходя по всем ячейкам, мы определяем расстояние между нашим пикселем и смещенными точками, значение шума Вороного – минимальное из расстояний, а инвертировав шум Вороного, получаем искомый шум Ворлея. 
Недостаток – этот шум не складывается воедино, т.~е. при сложении текстур созданных с помощью шума, получаются резкие стыки, чтобы это исправить, необходимо брать смещение точки по модулю \cite{worley}.

\subsection{Шум Перлина}

Шум Перлина — это градиентный шум, состоящий из набора псевдослучайных единичных векторов (направлений градиента), расположенных в определенных точках пространства и интерполированных функцией сглаживания между этими точками. Беря по модулю псевдослучайные числа, добиваемся того, что текстуры созданные с помощью шума, складываются воедино. 



\section{Существующие примеры моделирования объемных облаков}

Использование процедурной генерации описанной в пункте \ref{partmediaref}, считается современным стандартом моделирования облаков в компьютерных играх и фильмах. Этот метод применялся в:
\begin{itemize}
	\item Компьютерной игре <<Horizon Zero Dawn>> \cite{hzd};
	\item Игровом движке Frostbite \cite{frostbite};
	\item Фильме <<Оз: Великий и Ужасный>> \cite{oz};
\end{itemize}


\img{75mm}{hzdimg}{Облака созданные с помощью процедурной генерации и погодных карт в игре <<Horizon Zero Dawn>>}
\img{75mm}{ozimg}{Облака созданные с помощью участвующей среды и аппроксимацией множественного рассеивания в фильме <<Оз: Великий и Ужасный>>}








